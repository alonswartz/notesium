<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.9.1/dist/cdn.min.js"></script>
  </head>
  <body>

    <div x-data="streamData" x-init="fetchStream('/api/stream/list?sort=alpha')">
      <div class="h-screen mx-auto h-full flex flex-col overflow-y-auto p-24">
        <div class="bg-gray-300 flex p-2 items-center justify-items-center justify-between rounded-lg">
          <div class="text-sm space-x-1">
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchStream('/api/stream/list?sort=alpha')">list</button>
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchStream('/api/stream/links')">links</button>
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchStream('/api/stream/lines')">lines</button>
            <input class="border border-gray-400 py-1 px-2 w-96 rounded-lg" placeholder="/api/stream/..." x-model="uri" @change="fetchStream(uri)" />
          </div>
          <p class="text-sm" x-text="lines.length"></p>
        </div>

        <div class="flex py-2 items-center justify-items-center justify-between">
          <input x-ref="queryInput" x-model="query" class="border border-gray-400 py-2 px-2 w-full rounded-lg text-sm" placeholder="filter..." />
        </div>
        <div class="h-full overflow-y-auto grid grid-cols-2 divide-x divide-gray-300">
          <select x-model="selected" id="options" role="listbox" size=5
            class="max-h-full overflow-y-auto py-1 text-sm font-mono text-gray-800 focus:outline-none">
            <template x-for="line, index in filterLines()">
              <option :selected="selected==index" class="checked:!bg-blue-500 checked:text-white hover:bg-indigo-600/10 cursor-pointer py-1" role="option" :value="index" x-text="line"></option>
            </template>
          </select>
          <div x-text="selected"></div>
        </div>
      </div>
    </div>

    <script>
      function streamData() {
        return {
          uri: '',
          query: '',
          lines: [],
          selected: 0,
          filterLines() {
            this.selected = 0;
            if (!this.query) return this.lines;
            const loweredQuery = this.query.toLowerCase();
            return this.lines.filter(line => { return line.toLowerCase().includes(loweredQuery); });
          },
          fetchStream(uri) {
            this.uri = uri;
            this.selected = 0;
            this.query = '';
            this.$nextTick(() => { this.$refs.queryInput.focus() });
            const self = this;
            fetch(this.uri)
              .then(response => {
                const reader = response.body.getReader();
                const stream = new ReadableStream({
                  start(controller) {
                    function push() {
                      reader.read().then(({ done, value }) => {
                        if (done) { controller.close(); buffer = ''; return; }
                        buffer += new TextDecoder().decode(value);
                        self.lines = buffer.trim().split('\n');
                        controller.enqueue(value); push();
                      });
                    }
                    var buffer = '';
                    push();
                  }
                });
                return new Response(stream);
              });
          },
        }
      }
    </script>

  </body>
</html>
