<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Raw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.9.1/dist/cdn.min.js"></script>
  </head>
  <body>

    <div x-data="rawData" x-init="fetchRaw('/api/raw/list?prefix=label&sort=alpha&color=true')">
      <div class="h-screen mx-auto h-full flex flex-col overflow-y-auto p-24">
        <div class="bg-gray-300 flex p-2 items-center justify-items-center justify-between rounded-lg">
          <div class="text-sm space-x-1">
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchRaw('/api/raw/list?color=true&prefix=label&sort=alpha')">list</button>
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchRaw('/api/raw/links?color=true')">links</button>
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchRaw('/api/raw/lines?color=true&prefix=title')">lines</button>
            <input class="border border-gray-400 py-1 px-2 w-96 rounded-lg" placeholder="/api/raw/..." x-model="uri" @change="fetchRaw(uri)" />
          </div>
        </div>

        <div class="flex py-2 items-center justify-items-center justify-between space-x-2">
          <input x-ref="queryInput" x-model="query" x-init="$watch('query', value => filterItems(value))" autofocus placeholder="filter..."
           @blur="$refs.queryInput.focus()"
           @keydown.down.prevent="selectDown()"
           @keydown.up.prevent="selectUp()"
           @keydown.ctrl.j.prevent="selectDown()"
           @keydown.ctrl.k.prevent="selectUp()"
           class="border border-gray-400 py-2 px-2 w-full rounded-lg text-sm" />
          <p class="text-sm text-right w-20" x-text="filteredItems.length + '/' + items.length"></p>
        </div>
        <div class="h-full overflow-y-auto grid grid-cols-2 divide-x divide-gray-300">
          <ul x-model="selected" role="listbox"
           class="max-h-full overflow-y-auto py-1 text-sm font-mono text-gray-800 focus:outline-none">
            <template x-for="item, index in filteredItems">
              <li :id="'item'+index" @click="selected = index" role="option"
               :class="(index === selected) ? '!bg-blue-500 text-white' : ''"
               class="hover:bg-indigo-600/10 cursor-pointer select-none px-4 py-1 whitespace-nowrap">
                <b x-text="item.Colored"></b>
                <span x-text="item.Content"></span>
              </li>
            </template>
          </ul>
          <div class="text-sm font-mono text-gray-800">
            <template x-if="filteredItems.length > 0">
              <pre x-text="filteredItems[selected].Filename"></pre>
            </template>
          </div>
        </div>
      </div>
    </div>

    <script>
      function rawData() {
        return {
          uri: '',
          query: '',
          items: [],
          filteredItems: [],
          filteredItemsMax: 300,
          selected: 0,
          selectUp() {
            if (this.selected !== 0) {
              this.selected -= 1; this.scrollIntoView(`item${this.selected}`)
            }
          },
          selectDown() {
            if (this.selected !== this.filteredItems.length - 1) {
              this.selected += 1; this.scrollIntoView(`item${this.selected}`)
            }
          },
          scrollIntoView(id) {
            document.getElementById(id).scrollIntoView({ block: 'nearest' });
          },
          filterItems() {
            const qs = this.query.toLowerCase();
            this.selected = 0;
            this.filteredItems = !this.query
              ? this.items.slice(0, this.filteredItemsMax)
              : this.items.filter(item => item.SearchStr.includes(qs)).slice(0, this.filteredItemsMax);
          },
          fetchRaw(uri) {
            this.uri = uri;
            this.query = '';
            this.selected = 0;
            this.$nextTick(() => { this.$refs.queryInput.focus() });
            fetch(this.uri)
              .then(response => response.text())
              .then(text => {
                 const PATTERN = /^(.*?):(.*?):\s*(?:\x1b\[0;36m(.*?)\x1b\[0m\s*)?(.*)$/
                 this.items = text.trim().split('\n').map(line => {
                   const matches = PATTERN.exec(line);
                   if (!matches) return null;
                   const Filename = matches[1];
                   const Linenum = matches[2];
                   const Colored = matches[3] || '';
                   const Content = matches[4];
                   const SearchStr = Colored ? `${Colored} ${Content}`.toLowerCase() : Content.toLowerCase();
                   return { Filename, Linenum, Colored, Content, SearchStr };
                 }).filter(Boolean);
                 this.filterItems();
              });
          },
        }
      }
    </script>

  </body>
</html>
