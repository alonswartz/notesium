<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Raw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.9.1/dist/cdn.min.js"></script>
  </head>
  <body>

    <div x-data="rawData" x-init="fetchRaw('/api/raw/list?sort=alpha')">
      <div class="h-screen mx-auto h-full flex flex-col overflow-y-auto p-24">
        <div class="bg-gray-300 flex p-2 items-center justify-items-center justify-between rounded-lg">
          <div class="text-sm space-x-1">
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchRaw('/api/raw/list?sort=alpha')">list</button>
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchRaw('/api/raw/links')">links</button>
            <button class="bg-blue-600 text-white p-1 w-16 rounded-lg" @click="fetchRaw('/api/raw/lines')">lines</button>
            <input class="border border-gray-400 py-1 px-2 w-96 rounded-lg" placeholder="/api/raw/..." x-model="uri" @change="fetchRaw(uri)" />
          </div>
        </div>

        <div class="flex py-2 items-center justify-items-center justify-between space-x-2">
          <input x-ref="queryInput" x-model="query" x-init="$watch('query', value => filterItems(value))" autofocus placeholder="filter..."
           @blur="$refs.queryInput.focus()"
           @keydown.down.prevent="(selected !== filteredItems.length - 1) ? selected+=1: undefined"
           @keydown.up.prevent="(selected !== 0) ? selected-=1 : undefined;"
           @keydown.ctrl.j.prevent="(selected !== filteredItems.length - 1) ? selected+=1: undefined"
           @keydown.ctrl.k.prevent="(selected !== 0) ? selected-=1 : undefined;"
           class="border border-gray-400 py-2 px-2 w-full rounded-lg text-sm" />
          <p class="text-sm text-right w-20" x-text="filteredItems.length + '/' + items.length"></p>
        </div>
        <div class="h-full overflow-y-auto grid grid-cols-2 divide-x divide-gray-300">
          <select x-model="selected" id="options" role="listbox" size=5
           class="max-h-full overflow-y-auto py-1 text-sm font-mono text-gray-800 focus:outline-none">
            <template x-for="item, index in filteredItems">
              <option :selected="selected==index" :value="index" x-text="item.Content" role="option"
               class="checked:!bg-blue-500 checked:text-white hover:bg-indigo-600/10 cursor-pointer py-1"></option>
            </template>
          </select>
          <div class="text-sm font-mono text-gray-800">
            <template x-if="filteredItems.length > 0">
              <pre x-text="filteredItems[selected].Filename"></pre>
            </template>
          </div>
        </div>
      </div>
    </div>

    <script>
      function rawData() {
        return {
          uri: '',
          query: '',
          items: [],
          filteredItems: [],
          filteredItemsMax: 300,
          selected: 0,
          filterItems() {
            this.selected = 0;
            this.filteredItems = !this.query
              ? this.items.slice(0, this.filteredItemsMax)
              : this.items.filter(item => item.Content.toLowerCase().includes(this.query.toLowerCase())).slice(0, this.filteredItemsMax);
          },
          fetchRaw(uri) {
            this.uri = uri;
            this.query = '';
            this.selected = 0;
            this.$nextTick(() => { this.$refs.queryInput.focus() });
            fetch(this.uri)
              .then(response => response.text())
              .then(text => {
                 this.items = text.trim().split('\n').map(line => {
                   const [Filename, Lineno, ...contentParts] = line.split(':');
                   const Content = contentParts.join(':');
                   return { Filename, Lineno, Content };
                 });
                 this.filterItems();
              });
          },
        }
      }
    </script>

  </body>
</html>
